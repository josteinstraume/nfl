---
title             : "NFL 2015: A Statistical Analysis"
# shorttitle        : "A Statistical Analysis"

author: 
  - name          : "Dave Dyer"
    affiliation   : "1"
  - name          : "Jostein Barry-Straume"
    affiliation   : "1"
  - name          : "Robert Flamenbaum"
    affiliation   : "1" 
  - name          : "Bryan Cikatz"
    affiliation   : "1"

affiliation:
  - id            : "1"
    institution   : "Southern Methodist University"

# abstract: |  



  
# keywords          : "keywords"
# wordcount         : "X"

bibliography      : ["r-references.bib"]

figsintext        : yes
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : no

lang              : "english"
class             : "jou"
output            : papaja::apa6_pdf
---

```{r load_packages, include = FALSE}
library("papaja")
library("mongolite")
library("dplyr") 
library("knitr")
library("tibble")
jostein_uri <- "mongodb://admin:KFTZXKMBGIWKMWJK@sl-us-south-1-portal.12.dblayer.com:28046,sl-us-south-1-portal.17.dblayer.com:28046/admin?3t.connection.name=JosteinDB&3t.connectTimeout=10000&3t.uriVersion=2&3t.certificatePreference=RootCACert:accept_any&3t.databases=admin,compose&3t.useClientCertPassword=false&readPreference=primary&ssl=true&3t.socketTimeout=0&3t.sharded=true&3t.connectionMode=multi"
m <- mongo(collection = "NFL", db = "test",  verbose = TRUE, url=jostein_uri, options = ssl_options(weak_cert_validation = T))
# m$count('{}')
# alldata <- m$find('{}')
# head(alldata)
```

# Abstract
 This study investigates how average and variance of yards gained impacts a given team's ability to get touchdowns in the NFL. The theory is that teams with high average yards gained, but with low variance, would get more touchdowns than those with higher average yards gained, but higher variance.  In other words, consistency is more important than big plays.

# The Data
 The data are the 2015 play-by-play records available at Kaggle (https://www.kaggle.com/maxhorowitz/nflplaybyplay2015).  These data are comprised of 46,129 rows describing every NFL play run over the 2015 season, by 32 teams.  There are 65 columns that include multiple values, including text description of the play / penalty, names of players , touchdown boolean flags, down markers, timestamps, game ids, and yardages.  In particular, here are the names of the fields involved for this study:

<!-- # EDA -->
<!-- We counted the number of offensive plays per team.  Are the top 10 teams, by play count: -->
<!-- ```{r offensive_plays, echo=FALSE} -->
<!-- teamoff <- alldata %>% -->
<!--   group_by(posteam) %>% -->
<!--   summarize(off_plays = n()) %>%  -->
<!--   arrange(desc(off_plays)) %>%  -->
<!--   na.omit() -->
<!-- names(teamoff) <- c("Team Name", "Offensive Play Count") -->
<!-- kable(teamoff[0:10,]) -->
<!-- ``` -->

```{r mongolite_queries, include=FALSE}
# Returns all plays that scored a touchdown with positive yard gains,
# grouping by team and count the plays per team, sorted in alphabetical order
ydsGainTD <- m$aggregate('[
		{ "$match": { "Yards.Gained": { "$gt": 0 }, "Touchdown": { "$gt": 0 } } },
    { "$group": { "_id": "$posteam" , "count": { "$sum": 1 } } },
    { "$sort": { "_id": 1} }
  ]')
ydsGainTD.tibble <- ydsGainTD

# Returns average yards gained and average number of touchdowns per team
avgYdsTds <- m$aggregate('[
  { "$group": {
      "_id": "$posteam",
      "ydsGainAvg": { "$avg": "$Yards.Gained" },
      "ydsGainSd": { "$stdDevPop": "$Yards.Gained"},
      "ydsGainSdSample": { "$stdDevSamp": "$Yards.Gained"},
      "tdsAvg": { "$avg": "$Touchdown" },
      "tdsSum": { "$sum": "$Touchdown" }
      }
  }]')
avgYdsTds.tibble <- avgYdsTds$`_id`

# Robert's query
# Returns sum of touchdowns and sum of penalty yards per team
sumTdsPenYds <- m$aggregate('[
  { "$group": { 
      "_id": { "posteam": "$posteam"},
      "Touchdown": { "$sum": "$Touchdown" },
      "Penalty_Yards": { "$sum": "$Penalty.Yards" }
    }
  }]')
sumTdsPenYds.tibble <- sumTdsPenYds$`_id`

# Robert's query
# Returns sum of touchdowns by quarter per team
sumTdsPerQtr <- m$aggregate('[
  { "$group": { 
    "_id": {"Team": "$posteam", "Quarter": "$qtr"},
    "Touchdown": { "$sum": "$Touchdown" }
    }
  }]')
sumTdsPerQtr.tibble <- sumTdsPerQtr$`_id`
```

```{r queries_output, echo=FALSE}
kable(cbind(ydsGainTD[0:10,],
            avgYdsTds[0:10,],
            sumTdsPenYds.tibble[0:10,],
            sumTdsPerQtr.tibble[0:10,])
      )
# TODO: rename the columns here to make this understandable.
```

<!-- and we also analyzed the # of defensive plays per team: -->
<!-- ```{r defensive_plays, echo = FALSE}  -->
<!-- teamdef <- alldata %>% -->
<!--   group_by(DefensiveTeam) %>% -->
<!--   summarize(def_plays = n()) %>% -->
<!--   na.omit() -->
<!-- names(teamdef) <- c("Team Name", "Defensive Play Count") -->
<!-- kable(teamdef[0:10,]) -->
<!-- # TODO:  add wins / losses per team as kable column. -->
<!-- # TODO:  See if there's a way to compress this so it's not too long; maybe top 5? -->
<!-- # TODO:  Add penalty count per team -->
<!-- # TODO:  Add avg / std yards gained per team. -->
<!-- ``` -->

<!-- ```{r table, echo=FALSE} -->
<!-- library(knitr) -->
<!-- nflwins  <- data.frame( -->
<!--   teams = c("broncos", "chargers", "oilers"), -->
<!--   wins = c(10, 12, 5),  -->
<!--   losses = c(4, 2, 9) -->
<!-- ) -->

<!-- kable(nflwins, caption= "W/L Data") -->
<!-- ``` -->

# The Tools
For this analysis, we use MongoDB for data mining and basic statistics, and R for data visualization and Markdown.  We originally had planned on using MySQL on bluemix, but abandoned it in favor of Mongo after some serious issues whist loading the data. 

We used Mongodb hosted on IBM Bluemix and Rstudio with Rmarkdown for the analysis, visualization and writeup.

```{r tools, echo = FALSE}
words <- c("Bluemix Storage", "Data Size", "Database Server", "Database Version", "Database Location", "Cloud Hosting Service", "Processors", "Memory")
numbers <- c("1GB", "14.3MB", "Compose for MongoDB-jj", "3.2.11", "US South", "IBM Bluemix", "1 x 2.0 GHz Cores", "1GB RAM")
specs <- data.frame("Bluemix Technical Specifications"= words, "Specifications"= numbers)
kable(specs)
```

# Results
<!-- # TODO:  Implementation using R scripts: Write some R scripts to analyze data essentially. Make some plots. Does high variance of yards gained mean less touchdowns compared to teams with low variance? Show this with plots. -->

# Discussion
We used `r cite_r("r-references.bib")` for all our analyses.


# Conclusion

# Appendices


\newpage

# References
```{r create_r-references}
r_refs(file = "r-references.bib")
```

\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}
