---
title             : "NFL 2015: A Statistical Analysis"
author            : "Dave, Jostein, Bryan and Robert"
date              : "November 28, 2017"
output: 
  pdf_document: 
    pandoc_args: [
      "-V", "classoption=twocolumn"
      ]
---


```{r load_packages, include = FALSE}
#library("papaja")
library("mongolite")
library("dplyr") 
library("knitr")
library("tibble")
jostein_uri <- "mongodb://admin:KFTZXKMBGIWKMWJK@sl-us-south-1-portal.12.dblayer.com:28046,sl-us-south-1-portal.17.dblayer.com:28046/admin?3t.connection.name=JosteinDB&3t.connectTimeout=10000&3t.uriVersion=2&3t.certificatePreference=RootCACert:accept_any&3t.databases=admin,compose&3t.useClientCertPassword=false&readPreference=primary&ssl=true&3t.socketTimeout=0&3t.sharded=true&3t.connectionMode=multi"
m <- mongo(collection = "NFL", db = "test",  verbose = TRUE, url=jostein_uri, options = ssl_options(weak_cert_validation = T))
m$count('{}')
alldata <- m$find('{}')
head(alldata)
```

# Abstract
 This study investigates how average and variance of yards gained impacts a given team's ability to get touchdowns in the NFL. The theory is that teams with high average yards gained, but with low variance, would get more touchdowns than those with higher average yards gained, but higher variance.  In other words, consistency is more important than big plays.

# Related Work
There are two related works that also use NFL play-by-play data to ascertain trends in yardage and touchdowns.  The first, "Underrated NFL Stats" [@Iyer] looks into the big plays allowed by the defense and the teams with the best / worst big plays allowed stats.  The second, "How to Quantify the NFL" [@Kelly] looks at big play differentials, but doesn't actually do any statistical analysis.  Our analysis focuses on the variance of the yardage per play numbers and measures the efficacy of teams by measuring the touchdowns from each game & team.


# Introduction
The data are the 2015 play-by-play records available at Kaggle (https://www.kaggle.com/maxhorowitz/nflplaybyplay2015).  These data are comprised of 46,129 rows describing every NFL play run over the 2015 season, by 32 teams.  There are 65 columns that include multiple values, including text description of the play / penalty, names of players , touchdown boolean flags, down markers, timestamps, game ids, and yardages.  For the purposes of this study, we focused on the average and variance of yards per play, by team, and measured the 'success' of the team based on the count of touchdowns per game.  

```{r mongolite_queries, include=FALSE}
# Returns all plays that scored a touchdown with positive yard gains,
# grouping by team and count the plays per team, sorted in alphabetical order
ydsGainTD <- m$aggregate('[
		{ "$match": { "Yards.Gained": { "$gt": 0 }, "Touchdown": { "$gt": 0 } } },
    { "$group": { "_id": "$posteam" , "count": { "$sum": 1 } } },
    { "$sort": { "_id": 1} }
  ]')
ydsGainTD.tibble <- ydsGainTD

# Returns average yards gained and average number of touchdowns per team
avgYdsTds <- m$aggregate('[
  { "$group": {
      "_id": "$posteam",
      "ydsGainAvg": { "$avg": "$Yards.Gained" },
      "ydsGainSd": { "$stdDevPop": "$Yards.Gained"},
      "ydsGainSdSample": { "$stdDevSamp": "$Yards.Gained"},
      "tdsAvg": { "$avg": "$Touchdown" },
      "tdsSum": { "$sum": "$Touchdown" }
      }
  }]')
avgYdsTds.tibble <- avgYdsTds$`_id`

# Returns sum of touchdowns and sum of penalty yards per team
sumTdsPenYds <- m$aggregate('[
  { "$group": { 
      "_id": { "posteam": "$posteam"},
      "Touchdown": { "$sum": "$Touchdown" },
      "Penalty_Yards": { "$sum": "$Penalty.Yards" }
    }
  }]')
sumTdsPenYds.tibble <- sumTdsPenYds$`_id`

# Returns sum of touchdowns by quarter per team
sumTdsPerQtr <- m$aggregate('[
  { "$group": { 
    "_id": {"Team": "$posteam", "Quarter": "$qtr"},
    "Touchdown": { "$sum": "$Touchdown" }
    }
  }]')
sumTdsPerQtr.tibble <- sumTdsPerQtr$`_id`

ydsGainVTd <- m$aggregate('[
  { "$group": {
      "_id": { "GameID": "$GameID", "PosTeam":"$posteam"},
      "SumTDs": { "$sum": "$Touchdown"},
      "SumYdsGain": { "$sum": "$Yards.Gained"}, 
      "AvgYdsGain": { "$avg": "Yards.Gained"},
      "SDYdsGain": { "$stdDevPop": "$Yards.Gained"}
  }}]')

```

# The Tools
For this analysis, we use MongoDB for data mining and basic statistics, and R for data visualization and Markdown.  We originally had planned on using MySQL on bluemix, but abandoned it in favor of Mongo after some serious issues whist loading the data.  

We used Mongodb hosted on IBM Bluemix and Rstudio with Rmarkdown for the analysis, visualization and writeup.  We used many r packages to support our analysis and data mining.  For data mining, we used the mongolite package (https://jeroen.github.io/mongolite/) to connect to the bluemix data set and, where possible, we used mongo to do the statistical analysis in favor of R.  Below are the specifications for the Mongo Database:  
  
  

```{r tools, echo = FALSE}
words <- c("Bluemix Storage", "Data Size", "Database Server", "Database Version", "Database Location", "Cloud Hosting Service", "Processors", "Memory")
numbers <- c("1GB", "14.3MB", "Compose for MongoDB-jj", "3.2.11", "US South", "IBM Bluemix", "1 x 2.0 GHz Cores", "1GB RAM")
specs <- data.frame( words, numbers)
specs
#kable(specs, col.names = c("Bluemix Technical Specifications", "Specifications"))
```

# Analysis

When the spread of per-team yards-per-play is viewed in a quartile plot, it is easy to see that there is not a great amount of variance between the medians.  This is about what we'd expect, since the NFL is incredibly competitive, and self-normalizing due to constant trading, strategy and balance.  If one team was clearly dominant in median yards per play, we would expect that team to dominate the entire season, which is not the case.  However, there is quite a bit of difference in the outer quartiles and in the number of outliers.  These data support our investigation into whether or not a large variance changes team performance.  

```{r figure1, echo = FALSE, fig.pos="H"}
library(ggplot2)
bygame <- alldata %>%
  group_by_at(vars(posteam, GameID)) %>%
  summarize(TDgameSum = sum(Touchdown),
            avgYdsPerGamePerTeam = mean(Yards$Gained),
            sdYdsPerGamePerTeam = sd(Yards$Gained))
bp1 <- ggplot(data = bygame, aes(posteam, x = posteam, y = avgYdsPerGamePerTeam))
bp1 + geom_boxplot() + ylab("Yards Per Play") + xlab("Team") + ggtitle("Median Yards per Play (by Team)")
```  
To start, we decided to plot number of touchdowns against yards gained (per game).  We expect to see a linear trend upwards that illustrates the basic football concept of more yards = more points.  As you can see, there appears to be an upward trend -- that is, as yards increase, so does the number of touchdowns.  

```{r figure2, echo = FALSE, fig.pos="H"}
p2 <- ggplot(ydsGainVTd, aes(SumTDs, SumYdsGain)) + geom_point() + xlab("")
p2 + xlab("Touchdowns") + ylab("Yards") + ggtitle("Touchdowns vs. Yards (Per Game)")
# TODO: Need some words describing WTF this is.

```  

Text describing figure 3  

```{r figure3, echo = FALSE, fig.pos="H"}
ggplot(ydsGainVTd, aes(SumTDs, SDYdsGain, group = "_id.GameID")) + 
  geom_point() + xlab("Touchdowns") + ylab("StDev in Yards (Per Game)") + ggtitle("Touchdowns vs. Variance in Yards Per Game")
```

Then we finally settled on figure 4 to illustrate the relationship between Yards and Standard deviation.  Note that ti's not uniform linear growth, and that impacts the ability to discern whether or not the touchdowns / sd plot is a reliable measure of the underlying relationship.

```{r figure4, echo = FALSE, fig.pos="H"}
ggplot(ydsGainVTd, aes(SumYdsGain, SDYdsGain, group = "_id.GameID")) + 
  geom_point() + xlab("Yards") + ylab("StDev(Yards)") + ggtitle("Yards vs. StDev(Yards) per Game")
```
Text summing up all the things.

# Conclusion

This is where we wrap up all the things and make our conclusion.

# Appendices
Put code here.

# References
```{r create_r-references}
#r_refs(file = "r-references.bib")
```

\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}
